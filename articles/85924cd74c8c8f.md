---
title: "wavをバイナリから読み解く"
emoji: "👏"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["wav"]
published: false
---
# wavとは
音声情報を記述するファイルフォーマットの一つ。mp3などと違い、圧縮されていない生の離散波形データが入っています。この記事では、このwavフォーマットにはどのようなデータがどのように格納されているのかを調べます。
# 対象読者
RIFF形式でフォーマットされたバイナリファイルなどを読んだことがない方、音声ファイルフォーマットに興味のある方などが想定読者です。一部、wavファイル特有でないものについても触れます。
# まず眺める
こういうのは実際に本物のデータをいじくるのが良いと思います。
ちょうど手元にwaveファイルがあったので、これを解剖することにします。
## VScodeにバイナリ用の拡張を入れる
デフォルトのVScodeでwaveファイルを開こうとすると、次のように怒られます。
![](/images/85924cd74c8c8f/2022-06-18-20-08-17.png)
​
[Hex Editor](https://marketplace.visualstudio.com/items?itemName=ms-vscode.hexeditor) というVScode公式の拡張を入れることで、バイナリを快適に表示できます。
![](/images/85924cd74c8c8f/2022-06-18-20-08-35.png)
この時点で、「WAVE」などが確認できますね（画像右側、Decorded Text部を参照）。
# RIFFフォーマットについて
　waveのファイルフォーマットを説明するにあたって、まず「RIFF」フォーマットについて説明する必要があります。
　RIFFとは、複数の「チャンク」の入れ子構造によってファイルを構成するメタファイル形式のことで、waveはこの構造を採用しています。実際のRIFF形式のファイルの基本構造は以下のようになります。（[参考](https://johnloomis.org/cpe102/asgn/asgn1/riff.html))
![](/images/85924cd74c8c8f/2022-06-18-20-10-09.png)
　このように、RIFF形式のファイルでは「RIFFチャンク」の中にサブチャンクを連ねることでデータを記述しています。
　それぞれのチャンクは自身のチャンク型を示す**ID**、data領域の大きさを示す**Size**、そして**Data**領域からなります。IDは4byte文字列、Sizeは4Byte整数で表されます。data領域の中身はチャンク型によって異なります。

# RIFFチャンク
## ID領域
前述のように、waveファイルの一番先頭にはRIFFチャンクのIDである"RIFF"があるはずです。
![](/images/85924cd74c8c8f/2022-06-18-20-11-39.png)
確認できますね。UTF8において"RIFF"は、52 49 46 46です。  
　このIDのおかげで、ファイルが不正なものでないことをある程度保証できます。  
　このような、
ファイルフォーマット毎に固有の位置にある固有の値は**マジックナンバー**と呼ばれています。アプリケーションがファイルの種類を判断するとき、このマジックナンバーを参照しています。
## Size領域
　RIFFチャンクのIDが確認出来たら、次の4byteにあるSize領域を見ていきましょう。
![](/images/85924cd74c8c8f/2022-06-18-20-11-48.png)

RIFF形式において、複数バイトで表現される数値は**リトルエンディアン**です。  
　この場合は16進数で00 57 46 08を表しています。この値は10進数で5719560ですから、このファイルの残りの領域には5719560byteのデータがある、ということが分かります。
　これに、IDとSize分の8byteを足した値がファイル全体のサイズです。
　この値は、エクスプローラーから確認できるファイルサイズと一致します。（同じところを参照しているので当然）。
![](/images/85924cd74c8c8f/2022-06-18-20-12-00.png)
​
## Data領域
RIFFチャンクのData領域の先頭には、4Byteのファイルタイプ識別子が記述されます。
今回は"WAVE"です。
